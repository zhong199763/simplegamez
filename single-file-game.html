<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Airplane Combat Game</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #loading-text {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
        }
        #progress-container {
            width: 300px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        #username-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 900;
        }
        #username-form {
            background-color: #333;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        #username-form h2 {
            color: white;
            margin-top: 0;
        }
        #username-input {
            padding: 10px;
            font-size: 16px;
            width: 250px;
            margin-bottom: 20px;
            border: none;
            border-radius: 5px;
        }
        #start-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #start-button:hover {
            background-color: #45a049;
        }
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        #health-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        #health-bar {
            width: 100%;
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s;
        }
        #mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            display: none;
            pointer-events: auto;
        }
        .joystick {
            position: absolute;
            bottom: 50px;
            width: 100px;
            height: 100px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        #left-joystick {
            left: 50px;
        }
        #right-joystick {
            right: 50px;
        }
        .joystick-knob {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }
        #fire-button {
            position: absolute;
            bottom: 50px;
            right: 180px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        #store-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            z-index: 101;
            pointer-events: auto;
            display: none;
        }
        #currency-display {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            color: gold;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            z-index: 100;
        }
        #game-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 150;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div id="loading-text">Loading Game...</div>
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
    </div>

    <div id="username-modal">
        <div id="username-form">
            <h2>Enter Your Pilot Name</h2>
            <input type="text" id="username-input" placeholder="Enter your name" maxlength="15">
            <button id="start-button">Start Game</button>
        </div>
    </div>

    <div id="game-container"></div>

    <div id="hud">
        <div id="score">Score: 0</div>
        <div id="health-container">
            <div id="health-bar"></div>
        </div>
        <div id="mobile-controls">
            <div id="left-joystick" class="joystick">
                <div class="joystick-knob"></div>
            </div>
            <div id="right-joystick" class="joystick">
                <div class="joystick-knob"></div>
            </div>
            <div id="fire-button">FIRE</div>
        </div>
        <div id="game-message"></div>
    </div>

    <button id="store-button">Store</button>

    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script>
        // Main game class that handles all game logic and rendering
        class Game {
            constructor() {
                // Initialize core systems
                this.setupGameState();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Start loading assets
                this.loadAssets();
            }
            
            setupGameState() {
                // Game state
                this.isLoading = true;
                this.username = '';
                this.score = 0;
                this.health = 100;
                this.virtualCurrency = 100;
                this.isRunning = false;
                this.enemies = [];
                this.bullets = [];
                this.lastShotTime = 0;
                this.shotCooldown = 0.2; // seconds
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }
            
            setupEventListeners() {
                // Username form submission
                document.getElementById('start-button').addEventListener('click', () => {
                    const usernameInput = document.getElementById('username-input');
                    this.username = usernameInput.value.trim() || 'Pilot_' + Math.floor(Math.random() * 1000);
                    this.startGame();
                });
                
                // Handle window resize
                window.addEventListener('resize', this.onWindowResize.bind(this));
                
                // Add store button event
                document.getElementById('store-button').addEventListener('click', () => {
                    this.showStore();
                });
            }
            
            loadAssets() {
                // Show loading screen
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.display = 'flex';
                
                // Setup progress tracking
                const progressBar = document.getElementById('progress-bar');
                
                // Simulate loading progress
                let progress = 0;
                const loadingInterval = setInterval(() => {
                    progress += 0.1;
                    progressBar.style.width = `${Math.min(progress * 100, 100)}%`;
                    
                    if (progress >= 1) {
                        clearInterval(loadingInterval);
                        this.isLoading = false;
                        
                        // Hide loading screen, show username modal
                        loadingScreen.style.display = 'none';
                        document.getElementById('username-modal').style.display = 'flex';
                    }
                }, 200);
            }
            
            startGame() {
                // Hide username modal
                document.getElementById('username-modal').style.display = 'none';
                
                // Initialize game scene
                this.gameContainer = document.getElementById('game-container');
                
                // Create renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.shadowMap.enabled = true;
                this.gameContainer.appendChild(this.renderer.domElement);
                
                // Create scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.FogExp2(0x87CEEB, 0.0005);
                
                // Create camera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
                this.camera.position.set(0, 100, 300);
                this.cameraTarget = new THREE.Vector3(0, 0, 0);
                
                // Setup lighting
                this.setupLighting();
                
                // Setup environment
                this.setupEnvironment();
                
                // Create player airplane
                this.createPlayerAirplane();
                
                // Create enemy airplanes
                this.createEnemies(5);
                
                // Setup input handling
                this.setupInputHandling();
                
                // Show store button
                document.getElementById('store-button').style.display = 'block';
                
                // Add currency display
                this.addCurrencyDisplay();
                
                // Start game loop
                this.isRunning = true;
                this.lastTime = performance.now();
                this.animate();
                
                // Show welcome message
                this.showMessage('Welcome to Aerial Combat!', 3000);
            }
            
            setupLighting() {
                // Ambient light
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(ambientLight);
                
                // Directional light (sun)
                this.sunLight = new THREE.DirectionalLight(0xffffff, 1);
                this.sunLight.position.set(500, 1000, 200);
                this.sunLight.castShadow = true;
                this.sunLight.shadow.mapSize.width = 2048;
                this.sunLight.shadow.mapSize.height = 2048;
                this.sunLight.shadow.camera.near = 500;
                this.sunLight.shadow.camera.far = 2000;
                this.sunLight.shadow.camera.left = -1000;
                this.sunLight.shadow.camera.right = 1000;
                this.sunLight.shadow.camera.top = 1000;
                this.sunLight.shadow.camera.bottom = -1000;
                this.scene.add(this.sunLight);
            }
            
            setupEnvironment() {
                // Ground plane
                const groundGeometry = new THREE.PlaneGeometry(10000, 10000);
                const groundMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0x1a5c1a,
                    side: THREE.DoubleSide
                });
                this.ground = new THREE.Mesh(groundGeometry, groundMaterial);
                this.ground.rotation.x = Math.PI / 2;
                this.ground.position.y = -100;
                this.ground.receiveShadow = true;
                this.scene.add(this.ground);
                
                // Add some clouds (simple placeholders)
                const cloudGeometry = new THREE.SphereGeometry(50, 16, 16);
                const cloudMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8
                });
                
                for (let i = 0; i < 20; i++) {
                    const cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
                    cloud.position.set(
                        (Math.random() - 0.5) * 2000,
                        300 + Math.random() * 200,
                        (Math.random() - 0.5) * 2000
                    );
                    cloud.scale.set(
                        1 + Math.random() * 2,
                        0.5 + Math.random() * 0.5,
                        1 + Math.random() * 2
                    );
                    this.scene.add(cloud);
                }
            }
            
            createPlayerAirplane() {
                // Create airplane geometry
                const geometry = new THREE.ConeGeometry(5, 20, 8);
                geometry.rotateX(Math.PI / 2);
                
                // Create material
                const material = new THREE.MeshPhongMaterial({ color: 0x3366ff });
                
                // Create mesh
                this.playerAirplane = new THREE.Mesh(geometry, material);
                this.playerAirplane.position.set(0, 100, 0);
                this.playerAirplane.castShadow = true;
                this.playerAirplane.receiveShadow = true;
                
                // Add wings
                const wingGeometry = new THREE.BoxGeometry(30, 5, 2);
                const wingMaterial = new THREE.MeshPhongMaterial({ color: 0x3366ff });
                const leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
                leftWing.position.set(-15, 0, 0);
                this.playerAirplane.add(leftWing);
                
                const rightWing = new THREE.Mesh(wingGeometry, wingMaterial);
                rightWing.position.set(15, 0, 0);
                this.playerAirplane.add(rightWing);
                
                // Add tail
                const tailGeometry = new THREE.BoxGeometry(10, 5, 2);
                const tailMaterial = new THREE.MeshPhongMaterial({ color: 0x3366ff });
                const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                tail.position.set(0, 0, -10);
                this.playerAirplane.add(tail);
                
                // Add to scene
                this.scene.add(this.playerAirplane);
                
                // Player properties
                this.playerSpeed = 100;
                this.playerTurnSpeed = 2;
                this.playerHealth = 100;
            }
            
            createEnemies(count) {
                // Create enemies
                for (let i = 0; i < count; i++) {
                    // Create airplane geometry
                    const geometry = new THREE.ConeGeometry(5, 20, 8);
                    geometry.rotateX(Math.PI / 2);
                    
                    // Create material (red for enemies)
                    const material = new THREE.MeshPhongMaterial({ color: 0xff3333 });
                    
                    // Create mesh
                    const enemy = new THREE.Mesh(geometry, material);
                    
                    // Add wings
                    const wingGeometry = new THREE.BoxGeometry(30, 5, 2);
                    const wingMaterial = new THREE.MeshPhongMaterial({ color: 0xff3333 });
                    const leftWing = new THREE.Mesh(wingGeometry, wingMaterial);
                    leftWing.position.set(-15, 0, 0);
                    enemy.add(leftWing);
                    
                    const rightWing = new THREE.Mesh(wingGeometry, wingMaterial);
                    rightWing.position.set(15, 0, 0);
                    enemy.add(rightWing);
                    
                    // Add tail
                    const tailGeometry = new THREE.BoxGeometry(10, 5, 2);
                    const tailMaterial = new THREE.MeshPhongMaterial({ color: 0xff3333 });
                    const tail = new THREE.Mesh(tailGeometry, tailMaterial);
                    tail.position.set(0, 0, -10);
                    enemy.add(tail);
                    
                    // Random position
                    enemy.position.set(
                        (Math.random() - 0.5) * 1000,
                        100 + Math.random() * 200,
                        (Math.random() - 0.5) * 1000
                    );
                    
                    // Random rotation
                    enemy.rotation.y = Math.random() * Math.PI * 2;
                    
                    enemy.castShadow = true;
                    enemy.receiveShadow = true;
                    
                    // Add to scene
                    this.scene.add(enemy);
                    
                    // Enemy properties
                    enemy.speed = 50 + Math.random() * 30;
                    enemy.turnSpeed = 0.5 + Math.random() * 0.5;
                    enemy.health = 30;
                    enemy.lastShotTime = 0;
                    enemy.shotCooldown = 2 + Math.random() * 2; // seconds
                    
                    // Add to enemies array
                    this.enemies.push(enemy);
                }
            }
            
            setupInputHandling() {
                // Keyboard state
                this.keys = {};
                
                // Keyboard event listeners
                window.addEventListener('keydown', (e) => {
                    this.keys[e.code] = true;
                });
                
                window.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });
                
                // Mouse state
                this.mouse = {
                    x: 0,
                    y: 0,
                    isDown: false
                };
                
                // Mouse event listeners
                window.addEventListener('mousemove', (e) => {
                    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                });
                
                window.addEventListener('mousedown', (e) => {
                    if (e.button === 0) { // Left mouse button
                        this.mouse.isDown = true;
                    }
                });
                
                window.addEventListener('mouseup', (e) => {
                    if (e.button === 0) { // Left mouse button
                        this.mouse.isDown = false;
                    }
                });
                
                // Mobile controls
                if (this.isMobile) {
                    this.setupMobileControls();
                }
            }
            
            setupMobileControls() {
                // Show mobile controls
                document.getElementById('mobile-controls').style.display = 'block';
                
                // Touch state
                this.touch = {
                    leftJoystick: { active: false, x: 0, y: 0 },
                    rightJoystick: { active: false, x: 0, y: 0 },
                    fireButton: false
                };
                
                // Left joystick
                const leftJoystick = document.getElementById('left-joystick');
                const leftKnob = leftJoystick.querySelector('.joystick-knob');
                
                // Right joystick
                const rightJoystick = document.getElementById('right-joystick');
                const rightKnob = rightJoystick.querySelector('.joystick-knob');
                
                // Fire button
                const fireButton = document.getElementById('fire-button');
                
                // Touch event handlers
                document.addEventListener('touchstart', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        const x = touch.clientX;
                        const y = touch.clientY;
                        
                        // Check if touch is on left joystick
                        if (this.isPointInCircle(x, y, leftJoystick.getBoundingClientRect())) {
                            this.touch.leftJoystick.active = true;
                            this.touch.leftJoystick.id = touch.identifier;
                            this.updateJoystickPosition(leftJoystick, leftKnob, x, y);
                        }
                        
                        // Check if touch is on right joystick
                        else if (this.isPointInCircle(x, y, rightJoystick.getBoundingClientRect())) {
                            this.touch.rightJoystick.active = true;
                            this.touch.rightJoystick.id = touch.identifier;
                            this.updateJoystickPosition(rightJoystick, rightKnob, x, y);
                        }
                        
                        // Check if touch is on fire button
                        else if (this.isPointInCircle(x, y, fireButton.getBoundingClientRect())) {
                            this.touch.fireButton = true;
                            this.touch.fireButtonId = touch.identifier;
                        }
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        
                        // Update left joystick
                        if (this.touch.leftJoystick.active && touch.identifier === this.touch.leftJoystick.id) {
                            this.updateJoystickPosition(leftJoystick, leftKnob, touch.clientX, touch.clientY);
                        }
                        
                        // Update right joystick
                        else if (this.touch.rightJoystick.active && touch.identifier === this.touch.rightJoystick.id) {
                            this.updateJoystickPosition(rightJoystick, rightKnob, touch.clientX, touch.clientY);
                        }
                    }
                });
                
                document.addEventListener('touchend', (e) => {
                    for (let i = 0; i < e.changedTouches.length; i++) {
                        const touch = e.changedTouches[i];
                        
                        // Reset left joystick
                        if (this.touch.leftJoystick.active && touch.identifier === this.touch.leftJoystick.id) {
                            this.touch.leftJoystick.active = false;
                            this.touch.leftJoystick.x = 0;
                            this.touch.leftJoystick.y = 0;
                            this.resetJoystickPosition(leftKnob);
                        }
                        
                        // Reset right joystick
                        else if (this.touch.rightJoystick.active && touch.identifier === this.touch.rightJoystick.id) {
                            this.touch.rightJoystick.active = false;
                            this.touch.rightJoystick.x = 0;
                            this.touch.rightJoystick.y = 0;
                            this.resetJoystickPosition(rightKnob);
                        }
                        
                        // Reset fire button
                        else if (this.touch.fireButton && touch.identifier === this.touch.fireButtonId) {
                            this.touch.fireButton = false;
                        }
                    }
                });
            }
            
            isPointInCircle(x, y, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const radius = rect.width / 2;
                
                const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                
                return distance <= radius;
            }
            
            updateJoystickPosition(joystick, knob, x, y) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const radius = rect.width / 2 - knob.offsetWidth / 2;
                
                let dx = x - centerX;
                let dy = y - centerY;
                
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > radius) {
                    dx = dx * radius / distance;
                    dy = dy * radius / distance;
                }
                
                knob.style.transform = `translate(${dx}px, ${dy}px)`;
                
                // Update joystick values (-1 to 1)
                if (joystick.id === 'left-joystick') {
                    this.touch.leftJoystick.x = dx / radius;
                    this.touch.leftJoystick.y = dy / radius;
                } else {
                    this.touch.rightJoystick.x = dx / radius;
                    this.touch.rightJoystick.y = dy / radius;
                }
            }
            
            resetJoystickPosition(knob) {
                knob.style.transform = 'translate(0px, 0px)';
            }
            
            animate() {
                if (!this.isRunning) return;
                
                requestAnimationFrame(this.animate.bind(this));
                
                const now = performance.now();
                const deltaTime = (now - this.lastTime) / 1000;
                this.lastTime = now;
                
                // Update game logic
                this.update(deltaTime);
                
                // Render scene
                this.renderer.render(this.scene, this.camera);
            }
            
            update(deltaTime) {
                // Update player
                this.updatePlayer(deltaTime);
                
                // Update camera
                this.updateCamera();
                
                // Update enemies
                this.updateEnemies(deltaTime);
                
                // Update bullets
                this.updateBullets(deltaTime);
                
                // Check collisions
                this.checkCollisions();
            }
            
            updatePlayer(deltaTime) {
                // Movement speed
                const moveSpeed = this.playerSpeed * deltaTime;
                const turnSpeed = this.playerTurnSpeed * deltaTime;
                
                // Keyboard controls
                if (this.keys['KeyW'] || this.keys['ArrowUp']) {
                    // Move forward
                    const direction = new THREE.Vector3(0, 0, -1).applyEuler(this.playerAirplane.rotation);
                    this.playerAirplane.position.addScaledVector(direction, moveSpeed);
                }
                
                if (this.keys['KeyS'] || this.keys['ArrowDown']) {
                    // Move backward
                    const direction = new THREE.Vector3(0, 0, 1).applyEuler(this.playerAirplane.rotation);
                    this.playerAirplane.position.addScaledVector(direction, moveSpeed * 0.5);
                }
                
                if (this.keys['KeyA'] || this.keys['ArrowLeft']) {
                    // Turn left
                    this.playerAirplane.rotation.y += turnSpeed;
                }
                
                if (this.keys['KeyD'] || this.keys['ArrowRight']) {
                    // Turn right
                    this.playerAirplane.rotation.y -= turnSpeed;
                }
                
                if (this.keys['KeyQ']) {
                    // Roll left
                    this.playerAirplane.rotation.z += turnSpeed;
                }
                
                if (this.keys['KeyE']) {
                    // Roll right
                    this.playerAirplane.rotation.z -= turnSpeed;
                }
                
                // Mobile controls
                if (this.isMobile && this.touch.leftJoystick.active) {
                    // Move based on left joystick
                    const direction = new THREE.Vector3(0, 0, -1).applyEuler(this.playerAirplane.rotation);
                    this.playerAirplane.position.addScaledVector(direction, moveSpeed * -this.touch.leftJoystick.y);
                    
                    // Turn based on left joystick
                    this.playerAirplane.rotation.y -= turnSpeed * this.touch.leftJoystick.x;
                }
                
                if (this.isMobile && this.touch.rightJoystick.active) {
                    // Aim based on right joystick
                    this.playerAirplane.rotation.x += turnSpeed * this.touch.rightJoystick.y * 0.5;
                    this.playerAirplane.rotation.z -= turnSpeed * this.touch.rightJoystick.x * 0.5;
                }
                
                // Shooting
                const isShooting = this.mouse.isDown || (this.isMobile && this.touch.fireButton);
                
                if (isShooting) {
                    this.tryToShoot();
                }
                
                // Keep airplane within bounds
                const bounds = 1000;
                this.playerAirplane.position.x = Math.max(-bounds, Math.min(bounds, this.playerAirplane.position.x));
                this.playerAirplane.position.y = Math.max(20, Math.min(500, this.playerAirplane.position.y));
                this.playerAirplane.position.z = Math.max(-bounds, Math.min(bounds, this.playerAirplane.position.z));
                
                // Limit rotation
                this.playerAirplane.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, this.playerAirplane.rotation.x));
                this.playerAirplane.rotation.z = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, this.playerAirplane.rotation.z));
                
                // Gradually level out
                this.playerAirplane.rotation.x *= 0.95;
                this.playerAirplane.rotation.z *= 0.95;
            }
            
            updateCamera() {
                // Position camera behind player airplane
                const offset = new THREE.Vector3(0, 30, 150);
                offset.applyEuler(this.playerAirplane.rotation);
                
                this.camera.position.copy(this.playerAirplane.position).add(offset);
                
                // Look at point slightly ahead of player
                const lookAtOffset = new THREE.Vector3(0, 0, -100);
                lookAtOffset.applyEuler(this.playerAirplane.rotation);
                this.cameraTarget.copy(this.playerAirplane.position).add(lookAtOffset);
                
                this.camera.lookAt(this.cameraTarget);
            }
            
            updateEnemies(deltaTime) {
                for (let i = 0; i < this.enemies.length; i++) {
                    const enemy = this.enemies[i];
                    
                    // Move forward
                    const direction = new THREE.Vector3(0, 0, -1).applyEuler(enemy.rotation);
                    enemy.position.addScaledVector(direction, enemy.speed * deltaTime);
                    
                    // Turn towards player
                    const toPlayer = new THREE.Vector3().subVectors(this.playerAirplane.position, enemy.position);
                    const targetRotation = Math.atan2(toPlayer.x, -toPlayer.z);
                    
                    // Smoothly rotate towards target
                    let rotationDiff = targetRotation - enemy.rotation.y;
                    
                    // Normalize rotation difference to [-PI, PI]
                    while (rotationDiff > Math.PI) rotationDiff -= Math.PI * 2;
                    while (rotationDiff < -Math.PI) rotationDiff += Math.PI * 2;
                    
                    enemy.rotation.y += Math.sign(rotationDiff) * Math.min(Math.abs(rotationDiff), enemy.turnSpeed * deltaTime);
                    
                    // Keep enemy within bounds
                    const bounds = 1000;
                    enemy.position.x = Math.max(-bounds, Math.min(bounds, enemy.position.x));
                    enemy.position.y = Math.max(20, Math.min(500, enemy.position.y));
                    enemy.position.z = Math.max(-bounds, Math.min(bounds, enemy.position.z));
                    
                    // Enemy shooting
                    const now = performance.now() / 1000;
                    if (now - enemy.lastShotTime > enemy.shotCooldown) {
                        enemy.lastShotTime = now;
                        
                        // Check if player is in front of enemy
                        const enemyForward = new THREE.Vector3(0, 0, -1).applyEuler(enemy.rotation);
                        const enemyToPlayer = new THREE.Vector3().subVectors(this.playerAirplane.position, enemy.position).normalize();
                        const dot = enemyForward.dot(enemyToPlayer);
                        
                        if (dot > 0.8) { // Player is roughly in front of enemy
                            this.createBullet(enemy.position, enemyForward, false);
                        }
                    }
                }
            }
            
            tryToShoot() {
                const now = performance.now() / 1000;
                if (now - this.lastShotTime > this.shotCooldown) {
                    this.lastShotTime = now;
                    
                    // Create bullet
                    const direction = new THREE.Vector3(0, 0, -1).applyEuler(this.playerAirplane.rotation);
                    this.createBullet(this.playerAirplane.position, direction, true);
                }
            }
            
            createBullet(position, direction, isPlayerBullet) {
                // Create bullet geometry
                const geometry = new THREE.SphereGeometry(2, 8, 8);
                
                // Create material
                const material = new THREE.MeshBasicMaterial({ 
                    color: isPlayerBullet ? 0x00ff00 : 0xff0000 
                });
                
                // Create mesh
                const bullet = new THREE.Mesh(geometry, material);
                
                // Set position (offset from airplane)
                const offset = direction.clone().multiplyScalar(20);
                bullet.position.copy(position).add(offset);
                
                // Add to scene
                this.scene.add(bullet);
                
                // Bullet properties
                bullet.direction = direction;
                bullet.speed = 300;
                bullet.isPlayerBullet = isPlayerBullet;
                bullet.lifeTime = 2; // seconds
                bullet.age = 0;
                
                // Add to bullets array
                this.bullets.push(bullet);
            }
            
            updateBullets(deltaTime) {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    // Move bullet
                    bullet.position.addScaledVector(bullet.direction, bullet.speed * deltaTime);
                    
                    // Update age
                    bullet.age += deltaTime;
                    
                    // Remove old bullets
                    if (bullet.age > bullet.lifeTime) {
                        this.scene.remove(bullet);
                        this.bullets.splice(i, 1);
                    }
                }
            }
            
            checkCollisions() {
                // Check bullet collisions
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    
                    if (bullet.isPlayerBullet) {
                        // Check collision with enemies
                        for (let j = this.enemies.length - 1; j >= 0; j--) {
                            const enemy = this.enemies[j];
                            
                            if (this.checkBulletCollision(bullet, enemy)) {
                                // Remove bullet
                                this.scene.remove(bullet);
                                this.bullets.splice(i, 1);
                                
                                // Damage enemy
                                enemy.health -= 10;
                                
                                // Check if enemy is destroyed
                                if (enemy.health <= 0) {
                                    // Remove enemy
                                    this.scene.remove(enemy);
                                    this.enemies.splice(j, 1);
                                    
                                    // Increase score
                                    this.score += 100;
                                    document.getElementById('score').textContent = `Score: ${this.score}`;
                                    
                                    // Add currency
                                    this.addCurrency(10);
                                    
                                    // Create explosion
                                    this.createExplosion(enemy.position);
                                    
                                    // Create new enemy
                                    if (this.enemies.length < 5) {
                                        this.createEnemies(1);
                                    }
                                }
                                
                                break;
                            }
                        }
                    } else {
                        // Check collision with player
                        if (this.checkBulletCollision(bullet, this.playerAirplane)) {
                            // Remove bullet
                            this.scene.remove(bullet);
                            this.bullets.splice(i, 1);
                            
                            // Damage player
                            this.playerHealth -= 10;
                            document.getElementById('health-bar').style.width = `${this.playerHealth}%`;
                            
                            // Change health bar color
                            if (this.playerHealth > 60) {
                                document.getElementById('health-bar').style.backgroundColor = '#4CAF50';
                            } else if (this.playerHealth > 30) {
                                document.getElementById('health-bar').style.backgroundColor = '#FFEB3B';
                            } else {
                                document.getElementById('health-bar').style.backgroundColor = '#F44336';
                            }
                            
                            // Check if player is destroyed
                            if (this.playerHealth <= 0) {
                                this.gameOver();
                            }
                        }
                    }
                }
            }
            
            checkBulletCollision(bullet, target) {
                const distance = bullet.position.distanceTo(target.position);
                return distance < 15; // Collision radius
            }
            
            createExplosion(position) {
                // Create explosion geometry
                const geometry = new THREE.SphereGeometry(20, 16, 16);
                
                // Create material
                const material = new THREE.MeshBasicMaterial({
                    color: 0xff9900,
                    transparent: true,
                    opacity: 0.8
                });
                
                // Create mesh
                const explosion = new THREE.Mesh(geometry, material);
                explosion.position.copy(position);
                this.scene.add(explosion);
                
                // Animate explosion
                let scale = 1;
                const expandInterval = setInterval(() => {
                    scale += 0.2;
                    explosion.scale.set(scale, scale, scale);
                    material.opacity -= 0.05;
                    
                    if (material.opacity <= 0) {
                        clearInterval(expandInterval);
                        this.scene.remove(explosion);
                    }
                }, 50);
            }
            
            gameOver() {
                // Stop game loop
                this.isRunning = false;
                
                // Create game over screen
                const gameOverScreen = document.createElement('div');
                gameOverScreen.style.position = 'fixed';
                gameOverScreen.style.top = '0';
                gameOverScreen.style.left = '0';
                gameOverScreen.style.width = '100%';
                gameOverScreen.style.height = '100%';
                gameOverScreen.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                gameOverScreen.style.display = 'flex';
                gameOverScreen.style.flexDirection = 'column';
                gameOverScreen.style.justifyContent = 'center';
                gameOverScreen.style.alignItems = 'center';
                gameOverScreen.style.zIndex = '1000';
                
                // Game over text
                const gameOverText = document.createElement('h1');
                gameOverText.textContent = 'Game Over';
                gameOverText.style.color = 'white';
                gameOverText.style.marginBottom = '20px';
                
                // Score text
                const scoreText = document.createElement('p');
                scoreText.textContent = `Final Score: ${this.score}`;
                scoreText.style.color = 'white';
                scoreText.style.fontSize = '24px';
                scoreText.style.marginBottom = '30px';
                
                // Restart button
                const restartButton = document.createElement('button');
                restartButton.textContent = 'Play Again';
                restartButton.style.padding = '10px 20px';
                restartButton.style.backgroundColor = '#4CAF50';
                restartButton.style.color = 'white';
                restartButton.style.border = 'none';
                restartButton.style.borderRadius = '5px';
                restartButton.style.fontSize = '18px';
                restartButton.style.cursor = 'pointer';
                
                restartButton.addEventListener('click', () => {
                    // Reload the page to restart
                    window.location.reload();
                });
                
                // Add elements to game over screen
                gameOverScreen.appendChild(gameOverText);
                gameOverScreen.appendChild(scoreText);
                gameOverScreen.appendChild(restartButton);
                
                // Add game over screen to document
                document.body.appendChild(gameOverScreen);
            }
            
            onWindowResize() {
                // Update camera aspect ratio
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                
                // Update renderer size
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            addCurrencyDisplay() {
                const currencyDisplay = document.createElement('div');
                currencyDisplay.id = 'currency-display';
                currencyDisplay.textContent = `${this.virtualCurrency} Coins`;
                document.body.appendChild(currencyDisplay);
            }
            
            addCurrency(amount) {
                this.virtualCurrency += amount;
                document.getElementById('currency-display').textContent = `${this.virtualCurrency} Coins`;
            }
            
            showMessage(message, duration = 3000) {
                // Get message element
                const messageElement = document.getElementById('game-message');
                
                // Set message text
                messageElement.textContent = message;
                messageElement.style.opacity = '1';
                
                // Fade out after duration
                setTimeout(() => {
                    let opacity = 1;
                    const fadeInterval = setInterval(() => {
                        opacity -= 0.05;
                        messageElement.style.opacity = opacity;
                        
                        if (opacity <= 0) {
                            clearInterval(fadeInterval);
                            messageElement.textContent = '';
                        }
                    }, 50);
                }, duration);
            }
            
            showStore() {
                // Create store container
                const storeContainer = document.createElement('div');
                storeContainer.id = 'store-container';
                storeContainer.style.position = 'fixed';
                storeContainer.style.top = '0';
                storeContainer.style.left = '0';
                storeContainer.style.width = '100%';
                storeContainer.style.height = '100%';
                storeContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                storeContainer.style.display = 'flex';
                storeContainer.style.flexDirection = 'column';
                storeContainer.style.justifyContent = 'center';
                storeContainer.style.alignItems = 'center';
                storeContainer.style.zIndex = '2000';
                
                // Store header
                const storeHeader = document.createElement('div');
                storeHeader.style.width = '80%';
                storeHeader.style.maxWidth = '800px';
                storeHeader.style.display = 'flex';
                storeHeader.style.justifyContent = 'space-between';
                storeHeader.style.alignItems = 'center';
                storeHeader.style.marginBottom = '20px';
                
                // Store title
                const storeTitle = document.createElement('h2');
                storeTitle.textContent = 'In-Game Store';
                storeTitle.style.color = 'white';
                storeTitle.style.margin = '0';
                
                // Currency display
                const currencyDisplay = document.createElement('div');
                currencyDisplay.textContent = `${this.virtualCurrency} Coins`;
                currencyDisplay.style.color = 'gold';
                currencyDisplay.style.fontSize = '24px';
                
                // Add elements to header
                storeHeader.appendChild(storeTitle);
                storeHeader.appendChild(currencyDisplay);
                
                // Store content
                const storeContent = document.createElement('div');
                storeContent.style.width = '80%';
                storeContent.style.maxWidth = '800px';
                storeContent.style.maxHeight = '70vh';
                storeContent.style.overflowY = 'auto';
                storeContent.style.backgroundColor = 'rgba(50, 50, 50, 0.9)';
                storeContent.style.borderRadius = '5px';
                storeContent.style.padding = '20px';
                
                // Store items
                const storeItems = [
                    {
                        id: 'health_boost',
                        name: 'Health Boost',
                        description: 'Restore 50 health points',
                        price: 20,
                        action: () => {
                            this.playerHealth = Math.min(100, this.playerHealth + 50);
                            document.getElementById('health-bar').style.width = `${this.playerHealth}%`;
                            
                            // Change health bar color
                            if (this.playerHealth > 60) {
                                document.getElementById('health-bar').style.backgroundColor = '#4CAF50';
                            } else if (this.playerHealth > 30) {
                                document.getElementById('health-bar').style.backgroundColor = '#FFEB3B';
                            } else {
                                document.getElementById('health-bar').style.backgroundColor = '#F44336';
                            }
                            
                            this.showMessage('Health restored!');
                        }
                    },
                    {
                        id: 'speed_boost',
                        name: 'Speed Boost',
                        description: 'Increase speed by 20% for 30 seconds',
                        price: 30,
                        action: () => {
                            const originalSpeed = this.playerSpeed;
                            this.playerSpeed *= 1.2;
                            
                            this.showMessage('Speed boosted!');
                            
                            setTimeout(() => {
                                this.playerSpeed = originalSpeed;
                                this.showMessage('Speed boost ended');
                            }, 30000);
                        }
                    },
                    {
                        id: 'rapid_fire',
                        name: 'Rapid Fire',
                        description: 'Decrease shot cooldown by 50% for 20 seconds',
                        price: 40,
                        action: () => {
                            const originalCooldown = this.shotCooldown;
                            this.shotCooldown *= 0.5;
                            
                            this.showMessage('Rapid fire activated!');
                            
                            setTimeout(() => {
                                this.shotCooldown = originalCooldown;
                                this.showMessage('Rapid fire ended');
                            }, 20000);
                        }
                    },
                    {
                        id: 'enemy_clear',
                        name: 'Enemy Clear',
                        description: 'Destroy all enemies on screen',
                        price: 50,
                        action: () => {
                            // Destroy all enemies
                            for (let i = this.enemies.length - 1; i >= 0; i--) {
                                const enemy = this.enemies[i];
                                
                                // Create explosion
                                this.createExplosion(enemy.position);
                                
                                // Remove enemy
                                this.scene.remove(enemy);
                                this.enemies.splice(i, 1);
                                
                                // Increase score
                                this.score += 50;
                            }
                            
                            document.getElementById('score').textContent = `Score: ${this.score}`;
                            
                            // Create new enemies
                            this.createEnemies(5);
                            
                            this.showMessage('All enemies destroyed!');
                        }
                    }
                ];
                
                // Create store items
                storeItems.forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.style.backgroundColor = '#444';
                    itemCard.style.borderRadius = '5px';
                    itemCard.style.padding = '15px';
                    itemCard.style.marginBottom = '10px';
                    itemCard.style.display = 'flex';
                    itemCard.style.justifyContent = 'space-between';
                    itemCard.style.alignItems = 'center';
                    
                    // Item info
                    const itemInfo = document.createElement('div');
                    
                    // Item name
                    const itemName = document.createElement('h3');
                    itemName.textContent = item.name;
                    itemName.style.color = 'white';
                    itemName.style.margin = '0 0 5px 0';
                    
                    // Item description
                    const itemDescription = document.createElement('p');
                    itemDescription.textContent = item.description;
                    itemDescription.style.color = '#ccc';
                    itemDescription.style.margin = '0';
                    
                    // Add elements to item info
                    itemInfo.appendChild(itemName);
                    itemInfo.appendChild(itemDescription);
                    
                    // Buy button
                    const buyButton = document.createElement('button');
                    buyButton.textContent = `${item.price} Coins`;
                    buyButton.style.padding = '10px 15px';
                    buyButton.style.backgroundColor = this.virtualCurrency >= item.price ? '#4CAF50' : '#666';
                    buyButton.style.color = 'white';
                    buyButton.style.border = 'none';
                    buyButton.style.borderRadius = '5px';
                    buyButton.style.cursor = this.virtualCurrency >= item.price ? 'pointer' : 'not-allowed';
                    
                    // Buy button event
                    buyButton.addEventListener('click', () => {
                        if (this.virtualCurrency >= item.price) {
                            // Deduct currency
                            this.virtualCurrency -= item.price;
                            currencyDisplay.textContent = `${this.virtualCurrency} Coins`;
                            document.getElementById('currency-display').textContent = `${this.virtualCurrency} Coins`;
                            
                            // Execute item action
                            item.action();
                            
                            // Close store
                            document.body.removeChild(storeContainer);
                            
                            // Resume game
                            this.isRunning = true;
                            this.lastTime = performance.now();
                            this.animate();
                        }
                    });
                    
                    // Add elements to item card
                    itemCard.appendChild(itemInfo);
                    itemCard.appendChild(buyButton);
                    
                    // Add item card to store content
                    storeContent.appendChild(itemCard);
                });
                
                // Close button
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Close';
                closeButton.style.marginTop = '20px';
                closeButton.style.padding = '10px 20px';
                closeButton.style.backgroundColor = '#f44336';
                closeButton.style.color = 'white';
                closeButton.style.border = 'none';
                closeButton.style.borderRadius = '5px';
                closeButton.style.fontSize = '16px';
                closeButton.style.cursor = 'pointer';
                
                closeButton.addEventListener('click', () => {
                    document.body.removeChild(storeContainer);
                    
                    // Resume game
                    this.isRunning = true;
                    this.lastTime = performance.now();
                    this.animate();
                });
                
                // Add elements to store container
                storeContainer.appendChild(storeHeader);
                storeContainer.appendChild(storeContent);
                storeContainer.appendChild(closeButton);
                
                // Add store container to document
                document.body.appendChild(storeContainer);
                
                // Pause game while store is open
                this.isRunning = false;
            }
        }

        // Initialize game when DOM is loaded
        window.addEventListener('DOMContentLoaded', () => {
            window.game = new Game();
        });
    </script>
</body>
</html>
